// scanners/fuzzing/EnhancedVulnerabilityDetector.java
package scanners.fuzzing;

import core.Vulnerability;
import java.util.*;

public class EnhancedVulnerabilityDetector {

    private static final Set<String> NOSQL_INDICATORS = Set.of(
            "mongodb", "bson", "unexpected token", "json parse", "syntax error",
            "invalid operator", "dollar sign", "unexpected character"
    );

    private static final Set<String> SSTI_INDICATORS = Set.of(
            "49", "7*7", "template processing", "render error",
            "expression", "evaluation", "freemarker", "thymeleaf", "velocity"
    );

    private static final Set<String> LDAP_INDICATORS = Set.of(
            "ldap", "directory", "invalid dn", "search filter", "malformed filter",
            "attribute", "distinguished name", "invalid search"
    );

    private static final Set<String> COMMAND_INJECTION_SUCCESS = Set.of(
            "root:", "bin/bash", "cmd.exe", "microsoft", "linux",
            "etc/passwd", "windows", "system32"
    );

    private static final Set<String> SSRF_INDICATORS = Set.of(
            "ec2", "metadata", "aws", "amazon", "internal",
            "localhost", "127.0.0.1", "passwd", "root:"
    );

    public Vulnerability analyzeEnhancedResponse(ApiEndpoint endpoint, ApiParameter parameter,
                                                 String payload, HttpResponse response) {

        String responseBody = response.getBody().toLowerCase();
        int statusCode = response.getStatusCode();
        long responseTime = response.getResponseTime();

        // üî• NoSQL Injection Detection
        if (detectNoSqlInjection(responseBody, statusCode, payload)) {
            return createVulnerability(
                    endpoint, parameter, payload, response, responseTime,
                    "NoSQL Injection in " + parameter.getName(),
                    "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ NoSQL –∏–Ω—ä–µ–∫—Ü–∏—è —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä " + parameter.getName(),
                    Vulnerability.Severity.HIGH,
                    Vulnerability.Category.NOSQL_INJECTION
            );
        }

        // üî• SSTI Detection
        if (detectSSTI(responseBody, statusCode, payload, responseTime)) {
            return createVulnerability(
                    endpoint, parameter, payload, response, responseTime,
                    "Server-Side Template Injection in " + parameter.getName(),
                    "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ SSTI —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä " + parameter.getName(),
                    Vulnerability.Severity.HIGH,
                    Vulnerability.Category.SSTI
            );
        }

        // üî• LDAP Injection Detection
        if (detectLDAPInjection(responseBody, statusCode, payload)) {
            return createVulnerability(
                    endpoint, parameter, payload, response, responseTime,
                    "LDAP Injection in " + parameter.getName(),
                    "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ LDAP –∏–Ω—ä–µ–∫—Ü–∏—è —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä " + parameter.getName(),
                    Vulnerability.Severity.HIGH,
                    Vulnerability.Category.LDAP_INJECTION
            );
        }

        // üî• Command Injection Detection (—É–ª—É—á—à–µ–Ω–Ω—ã–π)
        if (detectCommandInjection(responseBody, statusCode, payload)) {
            return createVulnerability(
                    endpoint, parameter, payload, response, responseTime,
                    "Command Injection in " + parameter.getName(),
                    "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ Command Injection —É—è–∑–≤–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä " + parameter.getName(),
                    Vulnerability.Severity.CRITICAL,
                    Vulnerability.Category.COMMAND_INJECTION
            );
        }

        // üî• SSRF Detection
        if (detectSSRF(responseBody, statusCode, payload)) {
            return createVulnerability(
                    endpoint, parameter, payload, response, responseTime,
                    "SSRF Vulnerability in " + parameter.getName(),
                    "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç—å Server-Side Request Forgery",
                    Vulnerability.Severity.HIGH,
                    Vulnerability.Category.SSRF
            );
        }

        return null;
    }

    private boolean detectNoSqlInjection(String responseBody, int statusCode, String payload) {
        if (!payload.contains("$") && !payload.contains("{")) {
            return false;
        }

        boolean hasNoSqlError = false;
        for (String indicator : NOSQL_INDICATORS) {
            if (responseBody.contains(indicator)) {
                hasNoSqlError = true;
                break;
            }
        }

        boolean hasNoSqlPatterns = payload.contains("$ne") ||
                payload.contains("$gt") ||
                payload.contains("$regex") ||
                payload.contains("$where");

        return hasNoSqlError && hasNoSqlPatterns;
    }

    private boolean detectSSTI(String responseBody, int statusCode, String payload, long responseTime) {
        if (!payload.contains("{{") && !payload.contains("${") &&
                !payload.contains("<%=") && !payload.contains("#{")) {
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏–π
        if (payload.contains("7*7") && responseBody.contains("49")) {
            return true;
        }

        for (String indicator : SSTI_INDICATORS) {
            if (responseBody.contains(indicator)) {
                return true;
            }
        }

        // Time-based detection –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
        return responseTime > 3000 && payload.contains("{{");
    }

    private boolean detectLDAPInjection(String responseBody, int statusCode, String payload) {
        if (!payload.contains("(") && !payload.contains("*") && !payload.contains(")")) {
            return false;
        }

        for (String indicator : LDAP_INDICATORS) {
            if (responseBody.contains(indicator)) {
                return true;
            }
        }

        return false;
    }

    private boolean detectCommandInjection(String responseBody, int statusCode, String payload) {
        if (!payload.contains(";") && !payload.contains("|") &&
                !payload.contains("`") && !payload.contains("$(")) {
            return false;
        }

        // –£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
        for (String indicator : COMMAND_INJECTION_SUCCESS) {
            if (responseBody.contains(indicator)) {
                return true;
            }
        }

        // –û—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
        return responseBody.contains("command not found") ||
                responseBody.contains("permission denied") ||
                responseBody.contains("syntax error") ||
                (statusCode == 500 && payload.contains(";"));
    }

    private boolean detectSSRF(String responseBody, int statusCode, String payload) {
        if (!payload.contains("169.254.169.254") &&
                !payload.contains("localhost") &&
                !payload.contains("file://")) {
            return false;
        }

        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —É—Å–ø–µ—à–Ω–æ–≥–æ SSRF
        for (String indicator : SSRF_INDICATORS) {
            if (responseBody.contains(indicator)) {
                return true;
            }
        }

        return (statusCode == 200 && payload.contains("169.254.169.254"));
    }

    private Vulnerability createVulnerability(ApiEndpoint endpoint, ApiParameter parameter,
                                              String payload, HttpResponse response,
                                              long responseTime, String title, String description,
                                              Vulnerability.Severity severity, Vulnerability.Category category) {

        Vulnerability vuln = new Vulnerability();
        vuln.setTitle(title);
        vuln.setDescription(description);
        vuln.setSeverity(severity);
        vuln.setCategory(category);
        vuln.setEndpoint(endpoint.getPath());
        vuln.setMethod(endpoint.getMethod().name());
        vuln.setParameter(parameter.getName());
        vuln.setStatusCode(response.getStatusCode());
        vuln.setResponseTime(responseTime);

        String evidence = buildEnhancedEvidence(payload, response, responseTime, parameter, category);
        vuln.setEvidence(evidence);

        vuln.setRecommendations(generateEnhancedRecommendations(category));

        return vuln;
    }

    private String buildEnhancedEvidence(String payload, HttpResponse response,
                                         long responseTime, ApiParameter parameter,
                                         Vulnerability.Category category) {
        StringBuilder evidence = new StringBuilder();

        evidence.append("=== –†–ê–°–®–ò–†–ï–ù–ù–û–ï –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–û ===\n\n");
        evidence.append("–¢–ò–ü –£–Ø–ó–í–ò–ú–û–°–¢–ò: ").append(category).append("\n");
        evidence.append("–ü–ê–†–ê–ú–ï–¢–†: ").append(parameter.getName()).append("\n");
        evidence.append("–†–ê–°–ü–û–õ–û–ñ–ï–ù–ò–ï: ").append(parameter.getLocation()).append("\n\n");

        evidence.append("–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ù–´–ô PAYLOAD:\n");
        evidence.append(payload).append("\n\n");

        evidence.append("–ê–ù–ê–õ–ò–ó –û–¢–í–ï–¢–ê:\n");
        evidence.append("Status Code: ").append(response.getStatusCode()).append("\n");
        evidence.append("Response Time: ").append(responseTime).append("ms\n");
        evidence.append("Content Length: ").append(response.getBody().length()).append(" bytes\n\n");

        evidence.append("–ò–ù–î–ò–ö–ê–¢–û–†–´ –£–Ø–ó–í–ò–ú–û–°–¢–ò:\n");
        evidence.append(extractVulnerabilityIndicators(response.getBody(), category)).append("\n");

        return evidence.toString();
    }

    private String extractVulnerabilityIndicators(String responseBody, Vulnerability.Category category) {
        StringBuilder indicators = new StringBuilder();

        switch (category) {
            case NOSQL_INJECTION:
                for (String indicator : NOSQL_INDICATORS) {
                    if (responseBody.toLowerCase().contains(indicator)) {
                        indicators.append("‚Ä¢ –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä: ").append(indicator).append("\n");
                    }
                }
                break;
            case SSTI:
                for (String indicator : SSTI_INDICATORS) {
                    if (responseBody.toLowerCase().contains(indicator)) {
                        indicators.append("‚Ä¢ –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä: ").append(indicator).append("\n");
                    }
                }
                break;
            case LDAP_INJECTION:
                for (String indicator : LDAP_INDICATORS) {
                    if (responseBody.toLowerCase().contains(indicator)) {
                        indicators.append("‚Ä¢ –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä: ").append(indicator).append("\n");
                    }
                }
                break;
            case COMMAND_INJECTION:
                for (String indicator : COMMAND_INJECTION_SUCCESS) {
                    if (responseBody.toLowerCase().contains(indicator)) {
                        indicators.append("‚Ä¢ –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä: ").append(indicator).append("\n");
                    }
                }
                break;
            case SSRF:
                for (String indicator : SSRF_INDICATORS) {
                    if (responseBody.toLowerCase().contains(indicator)) {
                        indicators.append("‚Ä¢ –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä: ").append(indicator).append("\n");
                    }
                }
                break;
            default:
                indicators.append("‚Ä¢ –ü—Ä—è–º—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã\n");
        }

        return indicators.length() > 0 ? indicators.toString() : "‚Ä¢ –ü—Ä—è–º—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã\n";
    }

    private List<String> generateEnhancedRecommendations(Vulnerability.Category category) {
        List<String> recommendations = new ArrayList<>();

        switch (category) {
            case NOSQL_INJECTION:
                recommendations.add("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–æ–≥—É—é —Å—Ö–µ–º—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è JSON –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤");
                recommendations.add("–≠–∫—Ä–∞–Ω–∏—Ä—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã MongoDB ($, .)");
                recommendations.add("–ü—Ä–∏–º–µ–Ω—è–π—Ç–µ whitelist –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤");
                recommendations.add("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ORM —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç NoSQL –∏–Ω—ä–µ–∫—Ü–∏–π");
                break;

            case SSTI:
                recommendations.add("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–±–ª–æ–Ω—ã –≤–º–µ—Å—Ç–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏");
                recommendations.add("–ü—Ä–∏–º–µ–Ω—è–π—Ç–µ sandbox –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–æ–≤");
                recommendations.add("–≠–∫—Ä–∞–Ω–∏—Ä—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –≤ —à–∞–±–ª–æ–Ω–∞—Ö");
                recommendations.add("–û—Ç–∫–ª—é—á–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–π –≤ —à–∞–±–ª–æ–Ω–∞—Ö");
                break;

            case LDAP_INJECTION:
                recommendations.add("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ prepared statements –¥–ª—è LDAP –∑–∞–ø—Ä–æ—Å–æ–≤");
                recommendations.add("–≠–∫—Ä–∞–Ω–∏—Ä—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ LDAP —Å–∏–º–≤–æ–ª—ã: ( ) * \\");
                recommendations.add("–ü—Ä–∏–º–µ–Ω—è–π—Ç–µ whitelist –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è DN");
                recommendations.add("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ LDAP escaping —Ñ—É–Ω–∫—Ü–∏–∏");
                break;

            case SSRF:
                recommendations.add("–í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ URL –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤");
                recommendations.add("–ë–ª–æ–∫–∏—Ä—É–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–µ—Ç—è–º –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º");
                recommendations.add("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ whitelist —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤");
                recommendations.add("–ü—Ä–∏–º–µ–Ω—è–π—Ç–µ DNS rebinding protection");
                break;

            default:
                recommendations.add("–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —É—è–∑–≤–∏–º–æ—Å—Ç–∏");
                recommendations.add("–û–±–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏");
        }

        return recommendations;
    }
}