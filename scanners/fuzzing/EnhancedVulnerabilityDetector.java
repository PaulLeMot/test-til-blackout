package scanners.fuzzing;

import core.Vulnerability;
import core.Vulnerability.Category;
import core.Vulnerability.Severity;
import java.util.regex.Pattern;
import java.util.regex.Matcher;

public class EnhancedVulnerabilityDetector {

    public EnhancedVulnerabilityDetector() {
        // Конструктор
    }

    /**
     * Обнаружение инъекционных уязвимостей на основе анализа ответа
     */
    public Vulnerability detectInjection(ApiEndpoint endpoint, ApiParameter parameter,
                                         String payload, HttpResponse response, Category vulnerabilityType) {

        if (response == null) {
            return null;
        }

        String responseBody = response.getBody();
        int statusCode = response.getStatusCode();
        long responseTime = response.getResponseTime();

        switch (vulnerabilityType) {
            case SSTI:
                return detectSSTI(endpoint, parameter, payload, response, responseBody);
            case NOSQL_INJECTION:
                return detectNoSQLInjection(endpoint, parameter, payload, response, responseBody, responseTime);
            case PATH_TRAVERSAL:
                return detectPathTraversal(endpoint, parameter, payload, response, responseBody);
            default:
                return null;
        }
    }

    /**
     * Обнаружение уязвимостей Server-Side Template Injection
     */
    private Vulnerability detectSSTI(ApiEndpoint endpoint, ApiParameter parameter,
                                     String payload, HttpResponse response, String responseBody) {

        // Проверка шаблонов SSTI в ответе
        if (responseBody != null) {
            // Для payload {{7*7}} ищем "49" в ответе
            if (payload.contains("{{7*7}}") && responseBody.contains("49")) {
                return createVulnerability(
                        endpoint,
                        parameter,
                        "Server-Side Template Injection (SSTI)",
                        "Шаблонный движок выполнил математическое выражение {{7*7}} = 49",
                        Category.SSTI,
                        Severity.HIGH,
                        response
                );
            }

            // Для payload ${7*7} ищем "49" в ответе
            if (payload.contains("${7*7}") && responseBody.contains("49")) {
                return createVulnerability(
                        endpoint,
                        parameter,
                        "Server-Side Template Injection (SSTI)",
                        "Шаблонный движок выполнил математическое выражение ${7*7} = 49",
                        Category.SSTI,
                        Severity.HIGH,
                        response
                );
            }

            // Проверка других индикаторов шаблонных движков
            if (responseBody.contains("freemarker") ||
                    responseBody.contains("thymeleaf") ||
                    responseBody.contains("velocity") ||
                    responseBody.contains("mustache") ||
                    responseBody.contains("handlebars")) {
                return createVulnerability(
                        endpoint,
                        parameter,
                        "Потенциальная Server-Side Template Injection (SSTI)",
                        "Обнаружены индикаторы шаблонного движка в ответе",
                        Category.SSTI,
                        Severity.MEDIUM,
                        response
                );
            }
        }

        return null;
    }

    /**
     * Обнаружение NoSQL инъекций
     */
    private Vulnerability detectNoSQLInjection(ApiEndpoint endpoint, ApiParameter parameter,
                                               String payload, HttpResponse response,
                                               String responseBody, long responseTime) {

        // Проверка шаблонов NoSQL инъекций
        if (payload.contains("$ne") || payload.contains("$where")) {

            // Time-based обнаружение для sleep payloads
            if (payload.contains("sleep") && responseTime > 5000) {
                return createVulnerability(
                        endpoint,
                        parameter,
                        "NoSQL Injection - Time-Based",
                        "Время ответа указывает на успешную sleep инъекцию: " + responseTime + "ms",
                        Category.NOSQL_INJECTION,
                        Severity.HIGH,
                        response
                );
            }

            // Error-based обнаружение
            if (response.getStatusCode() == 500 ||
                    (responseBody != null &&
                            (responseBody.toLowerCase().contains("mongodb") ||
                                    responseBody.toLowerCase().contains("database") ||
                                    responseBody.toLowerCase().contains("syntax error")))) {
                return createVulnerability(
                        endpoint,
                        parameter,
                        "NoSQL Injection - Error-Based",
                        "Обнаружена ошибка базы данных или индикатор MongoDB в ответе",
                        Category.NOSQL_INJECTION,
                        Severity.HIGH,
                        response
                );
            }

            // Behavioral обнаружение - неожиданные данные в ответе
            if (response.getStatusCode() == 200 && responseBody != null &&
                    responseBody.length() > 1000) { // Большой ответ может указывать на утечку данных
                return createVulnerability(
                        endpoint,
                        parameter,
                        "NoSQL Injection - Data Exposure",
                        "Необычно большой ответ может указывать на утечку данных",
                        Category.NOSQL_INJECTION,
                        Severity.MEDIUM,
                        response
                );
            }
        }

        return null;
    }

    /**
     * Обнаружение уязвимостей Path Traversal
     */
    private Vulnerability detectPathTraversal(ApiEndpoint endpoint, ApiParameter parameter,
                                              String payload, HttpResponse response, String responseBody) {

        if (responseBody != null) {
            // Общие индикаторы успешного Path Traversal
            String[] successIndicators = {
                    "root:", "bin/bash", "etc/passwd", "etc/shadow", "boot.ini", "windows/system32",
                    "username:", "userid:", "groupid:", "home directory"
            };

            for (String indicator : successIndicators) {
                if (responseBody.toLowerCase().contains(indicator)) {
                    return createVulnerability(
                            endpoint,
                            parameter,
                            "Path Traversal Vulnerability",
                            "Обнаружен доступ к файловой системе с индикатором: " + indicator,
                            Category.PATH_TRAVERSAL,
                            Severity.HIGH,
                            response
                    );
                }
            }

            // Проверка паттернов листинга директорий
            if (responseBody.contains("<directory>") ||
                    responseBody.contains("<file>") ||
                    responseBody.contains("index of /")) {
                return createVulnerability(
                        endpoint,
                        parameter,
                        "Path Traversal - Directory Listing",
                        "Обнаружен листинг директории в ответе",
                        Category.PATH_TRAVERSAL,
                        Severity.MEDIUM,
                        response
                );
            }
        }

        return null;
    }

    /**
     * Обнаружение обходов бизнес-логики
     */
    public Vulnerability detectBusinessLogicBypass(ApiEndpoint endpoint, ApiParameter parameter,
                                                   String payload, HttpResponse response,
                                                   String expectedBehavior) {

        if (response == null) {
            return null;
        }

        int statusCode = response.getStatusCode();
        String responseBody = response.getBody();

        // Проверка обхода отрицательных сумм
        if (payload.contains("-") && expectedBehavior.contains("negative amount")) {
            if (statusCode == 200 || statusCode == 201) {
                return createVulnerability(
                        endpoint,
                        parameter,
                        "Business Logic Bypass - Negative Amount",
                        "Система приняла отрицательную сумму: " + payload,
                        Category.BUSINESS_LOGIC,
                        Severity.HIGH,
                        response
                );
            }
        }

        // Проверка обхода чрезмерных сумм
        if (payload.contains("999999999") && expectedBehavior.contains("excessive amount")) {
            if (statusCode == 200 || statusCode == 201) {
                return createVulnerability(
                        endpoint,
                        parameter,
                        "Business Logic Bypass - Excessive Amount",
                        "Система приняла чрезмерную сумму: " + payload,
                        Category.BUSINESS_LOGIC,
                        Severity.HIGH,
                        response
                );
            }
        }

        // Проверка нарушений граничных значений
        if (statusCode == 200 && expectedBehavior.contains("should be rejected")) {
            return createVulnerability(
                    endpoint,
                    parameter,
                    "Business Logic Bypass - Input Validation",
                    "Система приняла входные данные, которые должны были быть отклонены: " + payload,
                    Category.BUSINESS_LOGIC,
                    Severity.MEDIUM,
                    response
            );
        }

        return null;
    }

    /**
     * Создание стандартизированного объекта уязвимости
     */
    private Vulnerability createVulnerability(ApiEndpoint endpoint, ApiParameter parameter,
                                              String title, String description,
                                              Category category, Severity severity,
                                              HttpResponse response) {

        Vulnerability vuln = new Vulnerability();
        vuln.setTitle(title);
        vuln.setDescription(description);
        vuln.setCategory(category);
        vuln.setSeverity(severity);
        vuln.setEndpoint(endpoint.getPath());
        vuln.setMethod(endpoint.getMethod().name());

        if (parameter != null) {
            vuln.setParameter(parameter.getName());
        }

        if (response != null) {
            vuln.setStatusCode(response.getStatusCode());
            vuln.setEvidence(buildEvidence(response, description));
        }

        return vuln;
    }

    /**
     * Формирование доказательств из ответа
     */
    private String buildEvidence(HttpResponse response, String description) {
        StringBuilder evidence = new StringBuilder();
        evidence.append(description).append("\n\n");
        evidence.append("Status Code: ").append(response.getStatusCode()).append("\n");
        evidence.append("Response Time: ").append(response.getResponseTime()).append("ms\n");

        if (response.getBody() != null && !response.getBody().isEmpty()) {
            evidence.append("Response Body (first 500 chars): ").append(
                    response.getBody().length() > 500 ?
                            response.getBody().substring(0, 500) + "..." :
                            response.getBody()
            ).append("\n");
        }

        return evidence.toString();
    }
}